# Get Secrets
# Lint
# Restore
# Build
# Unit tests
# Integration tests
# Publish build artifacts
# Publish container image
parameters:
  - name: containerRegistryName
    type: string
    default: freddieentity.azurecr.io
  - name: containerImageName
    type: string
    default: weatherservice
  - name: containerImageTag
    type: string
    default: $(Build.BuildNumber)

stages:
  # UnitTest
  - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/test/unit-test.yaml
    parameters:
      stageName: UnitTest
      stageDependencies: 

  # SCA
  - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/security/sca/owasp-dependency-check.yaml
    parameters:
      stageName: SCA
      stageDependencies:
        - UnitTest

  # SAST
  - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/security/sast/sonarqube.yaml
    parameters:
      stageName: SAST
      stageDependencies:
        - UnitTest
      sonarQubeToken: 4ae523f01ada58d6b50e1667024d06494989a1c9
      sonarQubeOrganization: freddieentity
      sonarQubeProjectKey: complete-cicd
      sonarQubeSources: $(Pipeline.Workspace)
      sonarQubeHostURL: https://sonarcloud.io

  # Build
  - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/build/container-image-build.yaml
    parameters:
      stageName: ContainerImageBuild
      stageDependencies:
        - SCA
        - SAST
      containerRegistryName: ${{ parameters.containerRegistryName }}
      containerImageName: ${{ parameters.containerImageName }}
      containerImageTag: ${{ parameters.containerImageTag }}

  # Container Image Scan
  - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/security/container/trivy.yaml
    parameters:
      stageName: ContainerImageScan
      stageDependencies:
        - ContainerImageBuild
      trivyTemplatePath: https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/junit.tpl
      containerRegistryName: ${{ parameters.containerRegistryName }}
      containerImageName: ${{ parameters.containerImageName }}
      containerImageTag: ${{ parameters.containerImageTag }}

  # Development
  - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/deploy/basic.yaml
    parameters:
      environment: Development
      stageName: Development
      stageDependencies:
        - ContainerImageBuild
      deploymentPoolName: Homelabpool

  # Test
  - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/deploy/basic.yaml
    parameters:
      environment: Test
      stageName: Test
      stageDependencies:
        - Development
      deploymentPoolName: Homelabpool

  # DAST
  - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/security/dast/owasp-zap.yaml
    parameters:
      environment: Test
      stageName: DAST
      stageDependencies:
        - Test
      targetEndpoint: https://www.example.com
      reportOutputPath: /home/vsts/work/1/a/zap_report.html

  # Production
  - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/deploy/basic.yaml
    parameters:
      environment: Production
      stageName: Production
      stageDependencies:
        - DAST
        - Test
      deploymentPoolName: Homelabpool