# Deploy to staging
# Acceptance tests
# Promote container image
# Manual intervention (optional)
# Release
trigger: none
resources:
  pipelines:
  - ${{ each pipeline in $(MICROSERVICE_LIST) }}:
    - pipeline: ${{ pipeline }} # onlineboutique-weatherservice
     source: ${{ pipeline }} # onlineboutique-weatherservice
     trigger:
      branches:
       include:
        - refs/heads/main
        - refs/heads/develop
        - refs/heads/release/*

variables: # https://tsuyoshiushio.medium.com/how-to-pass-variables-with-pipeline-trigger-in-azure-pipeline-5771c5f18f91
  - template: ${{variables['System.DefaultWorkingDirectory']}}/variables/common/global.yaml

stages: # https://github.com/microsoft/azure-pipelines-yaml/blob/master/design/deployment-strategies.md
  # Development
  - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/deploy/aks.yaml
    parameters:
      environment: Development
      stageName: Development
      deploymentPoolName: Homelabpool
      azureServiceConnection: SC ARM
      containerRegistryName: $(CONTAINER_REGISTRY_NAME)
      containerImageName: $(Build.TriggeredBy.DefinitionName) # https://learn.microsoft.com/en-us/azure/devops/pipelines/repos/multi-repo-checkout?view=azure-devops#triggers
      containerImageTag: $(Build.TriggeredBy.BuildNumber)

  # # Test
  # - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/deploy/basic.yaml
  #   parameters:
  #     environment: Test
  #     stageName: Test
  #     stageDependencies:
  #       - Development
  #     deploymentPoolName: Homelabpool
  #     microserviceName: weatherservice

  # # Automation Test
  # - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/test/automation-test.yaml
  #   parameters:
  #     stageName: AutomationTest
  #     stageDependencies:
  #       - Test

  # # DAST
  # - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/security/dast/owasp-zap.yaml
  #   parameters:
  #     stageName: DAST
  #     stageDependencies:
  #       - Test
  #     targetEndpoint: https://www.example.com
  #     reportOutputPath: /home/vsts/work/1/a/zap_report.html
        
  # # Staging   
  # - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/deploy/basic.yaml
  #   parameters:
  #     environment: Staging
  #     stageName: Staging
  #     stageDependencies:
  #       - Test
  #     deploymentPoolName: Homelabpool
  #     microserviceName: weatherservice

  # # Production
  # - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/deploy/basic.yaml
  #   parameters:
  #     environment: Production
  #     stageName: Production
  #     stageDependencies:
  #       - Staging
  #     deploymentPoolName: Homelabpool
  #     microserviceName: weatherservice


parameters:
  - name: environment
    displayName: Environment
    type: string
    default: Development
  - name: containerRegistryName
    type: string
    default: freddieentity.azurecr.io
  - name: containerImageName
    type: string
    default: weatherservice
  - name: containerImageTag
    type: string
    default: $(Build.BuildNumber)