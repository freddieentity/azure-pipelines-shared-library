# Deploy to staging
# Acceptance tests
# Promote container image
# Manual intervention (optional)
# Release
trigger: none
resources:
  # containers:
  # - container: freddieentity
  #   image: freddieentity.azurecr.io/adservice:1.0
  pipelines:
   - pipeline: processingservice
     source: processingservice
     trigger:
      branches:
       include:
         - main
         - releases/*  
         - features/*
variables:
  - template: ${{variables['System.DefaultWorkingDirectory']}}/variables/common/global.yaml

stages:
  # Development
  - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/deploy/basic.yaml
    parameters:
      environment: Development
      stageName: Development
      deploymentPoolName: Homelabpool
      microserviceName: weatherservice

  # Test
  - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/deploy/basic.yaml
    parameters:
      environment: Test
      stageName: Test
      stageDependencies:
        - Development
      deploymentPoolName: Homelabpool
      microserviceName: weatherservice

  # Automation Test
  - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/test/automation-test.yaml
    parameters:
      stageName: AutomationTest
      stageDependencies:
        - Test

  # DAST
  - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/security/dast/owasp-zap.yaml
    parameters:
      stageName: DAST
      stageDependencies:
        - Test
      targetEndpoint: https://www.example.com
      reportOutputPath: /home/vsts/work/1/a/zap_report.html
        
  # Staging   
  - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/deploy/basic.yaml
    parameters:
      environment: Staging
      stageName: Staging
      stageDependencies:
        - Test
      deploymentPoolName: Homelabpool
      microserviceName: weatherservice

  # Production
  - template: ${{variables['System.DefaultWorkingDirectory']}}/templates/deploy/basic.yaml
    parameters:
      environment: Production
      stageName: Production
      stageDependencies:
        - Staging
      deploymentPoolName: Homelabpool
      microserviceName: weatherservice


parameters:
  - name: environment
    displayName: Environment
    type: string
    default: Development
  # - name: unitTestSourcesDirectory
  #   displayName: Unit Test Sources Directory
  #   type: string
  #   default: ''
  # - name: projectSourcesDirectory
  #   displayName: Project Sources Directory
  #   type: string
  #   default: ''
  - name: containerRegistryName
    type: string
    default: freddieentity.azurecr.io
  - name: containerImageName
    type: string
    default: weatherservice
  - name: containerImageTag
    type: string
    default: $(Build.BuildNumber)